<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>타이머 설정</title>
</head>
<body>
    <div class="container">
        <div class="header" id="a">타이머 설정</div>
        <div class="input-area" id="b">
            <input type="number" id="timerInput" maxlength="6" placeholder="6자리 숫자 입력">
            <button id="setTimerBtn">타이머 등록</button>
            <ul>
                <li>1. 숫자를 입력한다</li>
                <li>2. 타이머를 설정한다</li>
            </ul>
        </div>
        <div class="timer-list" id="c">
            <button id="sortBtn">정렬</button>
            <div id="timers"></div>
        </div>
    </div>

    <script>
        let timers = [];
        let sortOrder = 'asc'; // 정렬 기준

        document.getElementById('setTimerBtn').onclick = addTimer;
        document.getElementById('timerInput').onkeypress = function(event) {
            if (event.key === 'Enter') {
                addTimer();
            }
        };

        function addTimer() {
            const input = document.getElementById('timerInput');
            const timeInput = input.value;

            if (timeInput.length === 6) {
                const seconds = parseInt(timeInput.substr(0, 2)) * 3600 +
                                parseInt(timeInput.substr(2, 2)) * 60 +
                                parseInt(timeInput.substr(4, 2)) + 300; // 5분 추가

                const timerId = Date.now();
                const timer = { id: timerId, seconds: seconds, memo: '', intervalId: null };
                timers.push(timer);
                input.value = '';
                renderTimers();
                startTimer(timer); // 타이머 시작
            } else {
                alert("6자리 숫자를 입력해주세요.");
            }
        }

        function renderTimers() {
            const timersContainer = document.getElementById('timers');
            timersContainer.innerHTML = '';

            timers.forEach(timer => {
                const timerDiv = document.createElement('div');
                timerDiv.classList.add('timer-item');
                timerDiv.innerHTML = `
                    <div class="timer-memo">
                        <span id="timer-${timer.id}">${formatTime(timer.seconds)}</span>
                        <input type="text" placeholder="메모" value="${timer.memo}" onkeypress="updateMemo(event, ${timer.id})">
                    </div>
                    <button onclick="deleteTimer(${timer.id})">삭제</button>
                `;
                timersContainer.appendChild(timerDiv);
            });
        }

        function startTimer(timer) {
            const timerElement = document.getElementById(`timer-${timer.id}`);

            // 기존 타이머가 있다면 중지
            if (timer.intervalId) {
                clearInterval(timer.intervalId);
            }

            timer.intervalId = setInterval(() => {
                if (timer.seconds <= 0) {
                    clearInterval(timer.intervalId);
                    notifyUser(timer.memo); // 메모를 알림에 전달
                    deleteTimer(timer.id); // 타이머 종료 시 삭제
                } else {
                    timer.seconds--;
                    timerElement.innerText = formatTime(timer.seconds); // 즉시 갱신
                }
            }, 1000); // 1초마다 감소
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function deleteTimer(timerId) {
            const timerIndex = timers.findIndex(timer => timer.id === timerId);
            if (timerIndex !== -1) {
                clearInterval(timers[timerIndex].intervalId); // 타이머 중지
                timers.splice(timerIndex, 1); // 타이머 삭제
                renderTimers();
            }
        }

        function updateMemo(event, timerId) {
            if (event.key === 'Enter') {
                const memo = event.target.value;
                const timer = timers.find(t => t.id === timerId);
                if (timer) {
                    timer.memo = memo;
                }
            }
        }

        document.getElementById('sortBtn').onclick = function() {
            if (sortOrder === 'asc') {
                timers.sort((a, b) => a.seconds - b.seconds);
                sortOrder = 'desc';
            } else if (sortOrder === 'desc') {
                timers.sort((a, b) => b.seconds - a.seconds);
                sortOrder = 'input';
            } else {
                timers.sort((a, b) => a.id - b.id); // 입력 순서로 정렬
                sortOrder = 'asc';
            }
            renderTimers();
        };

        function notifyUser(memo) {
            const message = memo ? `${memo} 타이머 종료!` : '타이머 종료!';
            if (Notification.permission === "granted") {
                new Notification(message);
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(message);
                    }
                });
            }
        }

        // 알림 권한 요청
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }

        // 타이머 갱신 함수
        function updateTimers() {
            timers.forEach(timer => {
                const timerElement = document.getElementById(`timer-${timer.id}`);
                if (timerElement) {
                    timerElement.innerText = formatTime(timer.seconds); // 모든 타이머 갱신
                }
            });
        }

        // 1초마다 모든 타이머 갱신
        setInterval(updateTimers, 1000);
    </script>
</body>
</html>
